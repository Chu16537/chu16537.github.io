<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>blahJob</title>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 800px; margin: auto; text-align: center; } /* 將 body 內容置中 */
    h1 { margin-bottom: 1em; }
    .search-container { display: flex; justify-content: center; align-items: center; margin-bottom: 1em; } /* 容器置中並水平對齊 */
    input { width: 300px; padding: 0.5em; font-size: 1em; }
    button {
      padding: 0.5em; /* 調整按鈕內邊距以適應圖示 */
      font-size: 1em;
      margin-left: 0.5em;
      border: none;
      background: none; /* 移除按鈕預設樣式 */
      cursor: pointer;
    }
    .suggestions { margin-top: 0.5em; color: #666; text-align: left; } /* 建議靠左對齊 */
    .suggestion-list { list-style: none; padding: 0; margin: 0; text-align: left; } /* 建議列表靠左對齊 */
    .suggestion-item { display: block; padding: 0.2em 0.5em; cursor: pointer; }
    .suggestion-item:hover { background-color: #ddd; color: #333; }
    .suggestion-item.active { background-color: #ccc; color: #333; }
    .article {
      margin-top: 1.5em;
      padding: 1em;
      background: #f4f4f4;
      border-radius: 8px;
      border: 2px solid #ccc;
      position: relative;
      text-align: left; /* 文章內容靠左對齊 */
    }
    .article-action {
      position: absolute;
      top: 0.5em;
      left: 0.5em;
      font-size: 0.8em;
      color: #666;
      background-color: #eee;
      padding: 0.2em 0.5em;
      border-radius: 4px;
    }
    .article-info {
      text-align: center;
      margin-bottom: 1em;
    }
    .article-rating {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      font-size: 0.8em;
      color: #333;
      background-color: #eee;
      padding: 0.2em 0.5em;
      border-radius: 4px;
    }
    .article-feedback {
      margin-top: 1em;
      padding: 0.8em;
      border: 1px solid black;
      border-radius: 4px;
      background-color: #fff;
    }
    .green-border { border-color: green; }
    .red-border { border-color: red; }
    #loading { text-align: center; padding: 1em; color: #999; display: none; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <h1>blahJob</h1>
  <div class="search-container">
    <input type="text" id="inputBox" placeholder="輸入公司名稱" oninput="onInputChange()" />
    <button onclick="onConfirm()"><i class="fas fa-search"></i></button> </div>
  <div class="suggestions" id="suggestions"></div>
  <div id="result"></div>
  <div id="loading">載入中...</div>
  <script>
    let companyMap = {};
    let currentActiveSuggestion = null;
    let currentCompanyId = null;
    let allArticleData = [];
    let loadedArticleCount = 0;
    const articlesPerPage = 5;
    let isLoading = false;

    async function loadCompanyData() {
      const res = await fetch('data/company.json');
      companyMap = await res.json();
    }

    function onInputChange() {
      const keyword = document.getElementById('inputBox').value.trim().toLowerCase();
      const suggestionBox = document.getElementById('suggestions');
      suggestionBox.innerHTML = '';
      if (!keyword) {
        return;
      }
      const matched = Object.keys(companyMap).filter(key => key.includes(keyword));
      if (matched.length > 0) {
        const suggestionList = document.createElement('ul');
        suggestionList.className = 'suggestion-list';
        matched.forEach(item => {
          const li = document.createElement('li');
          li.className = 'suggestion-item';
          li.textContent = item;

          li.addEventListener('mouseenter', () => {
            if (currentActiveSuggestion) {
              currentActiveSuggestion.classList.remove('active');
            }
            li.classList.add('active');
            currentActiveSuggestion = li;
            document.getElementById('inputBox').value = item;
          });

          li.addEventListener('mouseleave', () => {
            li.classList.remove('active');
            currentActiveSuggestion = null;
            if (document.getElementById('inputBox').value !== item && !suggestionList.dataset.clicked) {
              document.getElementById('inputBox').value = document.getElementById('inputBox').dataset.previousValue || '';
            }
            delete suggestionList.dataset.clicked;
          });

          li.addEventListener('click', () => {
            document.getElementById('inputBox').value = item;
            suggestionBox.innerHTML = '';
            document.getElementById('inputBox').focus();
            suggestionList.dataset.clicked = true;
          });

          suggestionList.appendChild(li);
        });
        suggestionBox.appendChild(suggestionList);
        document.getElementById('inputBox').dataset.previousValue = keyword;
      } else {
        suggestionBox.textContent = '無匹配結果';
      }
    }

    async function loadAndDisplayArticles(companyId, startIndex, count) {
      if (isLoading) return;
      isLoading = true;
      document.getElementById('loading').style.display = 'block';
      const resultBox = document.getElementById('result');

      try {
        const res = await fetch(`data/${companyId}.json`);
        const data = await res.json();
        if (!Array.isArray(data)) {
          resultBox.innerHTML = '<p style="color: red;">⚠️ 資料格式錯誤，應為陣列</p>';
          return;
        }
        allArticleData = data;

        const endIndex = Math.min(startIndex + count, allArticleData.length);
        for (let i = startIndex; i < endIndex; i++) {
          const item = allArticleData[i];
          const articleDiv = document.createElement('div');
          articleDiv.className = 'article';

          if (item["本次動作"] === "工作") {
            if (item["當前狀態"] === "在職") {
              articleDiv.classList.add('green-border');
            } else if (item["當前狀態"] === "離職") {
              articleDiv.classList.add('red-border');
            }
          } else if (item["本次動作"] === "面試") {
            articleDiv.classList.add('green-border');
          }

          const actionSpan = document.createElement('span');
          actionSpan.className = 'article-action';
          actionSpan.textContent = item["本次動作"];
          articleDiv.appendChild(actionSpan);

          const infoDiv = document.createElement('div');
          infoDiv.className = 'article-info';
          infoDiv.textContent = item["職位名稱"];
          if (item["本次動作"] === "工作") {
            infoDiv.textContent += ` (${item["在職/離職日期"]})`;
          } else if (item["本次動作"] === "面試" && item["面試日期"]) {
            infoDiv.textContent += ` (面試日期：${item["面試日期"]})`;
          }
          articleDiv.appendChild(infoDiv);

          if (item["評分"]) {
            const ratingSpan = document.createElement('span');
            ratingSpan.className = 'article-rating';
            ratingSpan.textContent = `評分：${item["評分"]}`;
            articleDiv.appendChild(ratingSpan);
          }

          if (item["心得分享"]) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'article-feedback';
            feedbackDiv.textContent = item["心得分享"];
            articleDiv.appendChild(feedbackDiv);
          }

          resultBox.appendChild(articleDiv);
          loadedArticleCount++;
        }

        if (loadedArticleCount < allArticleData.length) {
          document.getElementById('loading').style.display = 'none';
        } else {
          document.getElementById('loading').textContent = '已載入所有資料';
        }
      } catch (err) {
        resultBox.innerHTML += '<p style="color: red;">⚠️ 載入資料失敗</p>';
        console.error(err);
        document.getElementById('loading').style.display = 'none';
      } finally {
        isLoading = false;
      }
    }

    function onConfirm() {
  const input = document.getElementById('inputBox').value.trim();
  const id = companyMap[input];
  const resultBox = document.getElementById('result');
  const suggestionBox = document.getElementById('suggestions'); // 取得建議框元素
  resultBox.innerHTML = '';
  allArticleData = [];
  loadedArticleCount = 0;
  document.getElementById('loading').textContent = '載入中...';
  suggestionBox.innerHTML = ''; // 清除建議選單內容

  if (!id) {
    resultBox.innerHTML = '<p style="color: red;">❌ 找不到對應資料</p>';
    document.getElementById('loading').style.display = 'none';
    currentCompanyId = null;
    return;
  }

  currentCompanyId = id;
  loadAndDisplayArticles(currentCompanyId, 0, articlesPerPage);
}

    window.addEventListener('scroll', () => {
      if (!currentCompanyId || isLoading) return;

      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      if (scrollTop + clientHeight >= scrollHeight - 5) {
        if (loadedArticleCount < allArticleData.length) {
          loadAndDisplayArticles(currentCompanyId, loadedArticleCount, articlesPerPage);
        }
      }
    });

    loadCompanyData();
  </script>
</body>
</html>